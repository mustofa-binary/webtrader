define(["exports","jquery","lodash","../windows/windows","../websockets/binary_websockets","../viewtransaction/viewTransaction","text!./profitTable.html","datatables","jquery-growl","../common/util","css!./profitTable.css"],function(e,t,a,r,o,n,i){"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.init=void 0;var s=p(t),l=p(a),c=p(r),d=p(o),u=p(n),f=p(i);function p(e){return e&&e.__esModule?e:{default:e}}var g=null,h=null,m=null,b=e.init=function(e){e.click(function(){g?g.moveToTop():d.default.cached.authorize().then(y).catch(function(e){s.default.growl.error({message:e.message})})})},v=!1,_=!1,w=function(e){var a=(0,s.default)("#"+h.attr("id")+"_processing").css("top","200px").show();v=!0;var t={profit_table:1,description:1,sort:"DESC"};if("string"==typeof e){t.date_from=yearMonthDayToEpoch(e,{utc:!0});var r=Date.UTC(1970,0,1,23,59,59)/1e3;t.date_to=t.date_from+r,h.api().rows().remove(),_=!0}else t.limit=250,(_||e.clear)&&(h.api().rows().remove(),_=!1),t.offset=h.api().column(0).data().length;var o=function(e){var t=(e.profit_table&&e.profit_table.transactions||[]).map(function(e){var t=(parseFloat(e.sell_price)-parseFloat(e.buy_price)).toFixed(currencyFractionalDigits()),a="<button>View</button>".i18n();try{e.longcode}catch(e){}return[epochToString(e.purchase_time,{utc:!0}),e.transaction_id,e.longcode,formatPrice(e.buy_price,local_storage.get("currency")),epochToString(e.sell_time,{utc:!0}),formatPrice(e.sell_price,local_storage.get("currency")),t,a,e]});h.api().rows.add(t),h.api().draw(),v=!1,a.hide()};d.default.send(t).then(o).catch(function(e){o({}),s.default.growl.error({message:e.message})})},T=function(e){var t=e.target,a=(0,s.default)(t);if("BUTTON"===t.tagName&&!a.hasClass("button-disabled")){var r=t.parentElement.parentElement,o=h.api().row(r).data();o=l.default.last(o),a.addClass("button-disabled"),u.default.init(o.contract_id,o.transaction_id).then(function(){return a.removeClass("button-disabled")}).catch(function(e){a.removeClass("button-disabled"),s.default.growl.error({message:e.message})})}},y=function(){(g=c.default.createBlankWindow((0,s.default)("<div/>"),{title:"Profit Table".i18n(),dialogClass:"profitTable",width:800,height:400,destroy:function(){h&&h.DataTable().destroy(!0),g=null},refresh:function(){m.clear(),w({clear:!0})},"data-authorized":"true"})).track({module_id:"profitTable",is_unique:!0,data:null}),(h=(0,s.default)(f.default).i18n()).appendTo(g);var l=(0,s.default)("<div/>").addClass("profit-table-info");h=h.dataTable({data:[],columnDefs:[{targets:6,createdCell:function(e,t){var a=t<0?"red":0<t?"green":"bold";a&&(0,s.default)(e).addClass(a),(0,s.default)(e).attr("data-src",t),e.innerHTML=formatPrice(t,local_storage.get("currency"))}}],info:!1,footerCallback:function(e,t,a,r,o){var n=this.api().column(6).data().reduce(function(e,t){return 1*e+1*t},0),i="total "+(0<=n?"green":"red");l.html('<span class="title">Total Profit/Loss<span><span class="'+i+'">'+formatPrice(n,local_storage.get("currency"))+"</span>")},paging:!1,ordering:!1,searching:!0,processing:!0}),l.i18n().appendTo(h.parent()),h.parent().addClass("hide-search-input"),h.api().columns().every(function(){var e=this;(0,s.default)("input",this.header()).on("keyup change",function(){e.search()!==this.value&&e.search(this.value).draw()})}),w({clear:!0}),m=g.addDateToHeader({title:"Jump to: ".i18n(),date:null,changed:w,cleared:w}),g.dialog("open"),g.on("click",T),g.scroll(function(){.75<(g.scrollTop()+g.innerHeight())/g[0].scrollHeight&&!v&&!_&&w({clear:!1})})};e.default={init:b}});