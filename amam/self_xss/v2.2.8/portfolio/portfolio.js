define(["exports","babel-runtime/regenerator","jquery","../windows/windows","../websockets/binary_websockets","jquery-ui","datatables","jquery-growl","css!./portfolio.css"],function(e,t,n,a,r){"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.proposal_open_contract=e.init=void 0;var i=l(t),c=l(n),o=l(a),s=l(r);function l(e){return e&&e.__esModule?e:{default:e}}var u=null,d=null,f=null,p=[],v=e.init=function(e){e.click(function(){u?u.moveToTop():x()})},b=function(e){if(!e.error){var t=e.proposal_open_contract,n=t.contract_id,a=t.bid_price;if(d){var r=d.api().row("#"+n),o=r.data();if(!o)return;var i=o[3];o[3]=a,r.data(o);var c=d.find("#"+n);t.is_valid_to_sell?(c.removeClass("resale-not-offered"),i!==a&&c.removeClass("indicative-red indicative-green").addClass(1*i<1*a?"indicative-green":"indicative-red")):c.removeClass("indicative-red indicative-green").addClass("resale-not-offered")}}},g=!1,h=0;s.default.events.on("logout",function(){g=!1,h=0});var m,w,y=function t(e){if("subscribe"===e)++h,!g&&0<h&&s.default.send({proposal_open_contract:1,subscribe:1}).then(function(e){g=!0}).catch(function(e){c.default.growl.error({message:e.message})});else if("forget"===e)--h,g&&0===h&&s.default.send({forget_all:"proposal_open_contract"}).then(function(e){g=!1}).catch(function(e){g=!1});else{if("resubscribe"!==e)return;s.default.send({forget_all:"proposal_open_contract"}).then(function(e){g=!1,--h,t("subscribe")}).catch(function(e){g=!1})}},C=function(e){var t=e.target,n=(0,c.default)(t);if("BUTTON"===t.tagName&&!n.hasClass("button-disabled")){var a=t.parentElement.parentElement,r=d.api().row(a).data();r=_.last(r),n.addClass("button-disabled"),require(["viewtransaction/viewTransaction"],function(e){e.init(r.contract_id,r.transaction_id).then(function(){return n.removeClass("button-disabled")}).catch(function(e){n.removeClass("button-disabled"),c.default.growl.error({message:e.message})})})}},x=function(){var n="",a=s.default.events.on("balance",function(e){void 0!==e.balance&&void 0!==e.balance.currency&&(n=e.balance.currency,f&&f&&f.update(e.balance.balance))}),r=((local_storage.get("i18n")||{value:"en"}).value,local_storage.get("active_symbols"),s.default.events.on("transaction",function(e){var t=e.transaction;if("buy"===t.action){var n="<button>View</button>".i18n(),a=[t.transaction_id,t.longcode,Math.abs(t.amount),"0.00",n,t.contract_id,t];t.date_expiry&&s.default.sell_expired(t.date_expiry),d.api().rows.add([a]),d.api().draw(),P([t])}else if("sell"===t.action){var r=d.find("#"+t.contract_id)[0];d.api().row(r).remove(),d.api().draw(),k([t])}}));s.default.send({balance:1}).then(function(e){n=e.balance.currency;var t=(u=o.default.createBlankWindow((0,c.default)("<div/>"),{title:"Portfolio".i18n(),dialogClass:"portfolio",width:700,height:400,"data-authorized":"true",close:function(){k(p),s.default.events.off("proposal_open_contract",b)},open:function(){T(),s.default.events.on("proposal_open_contract",b)},destroy:function(){d&&d.DataTable().destroy(!0),u=null,s.default.events.off("balance",a),s.default.events.off("transaction",r)},refresh:function(){s.default.send({balance:1}).catch(function(e){c.default.growl.error({message:e.message})}),k(p).then(T)}})).parent().find(".ui-dialog-title").addClass("with-content");(f=(0,c.default)('<span class="span-in-dialog-header" />').insertAfter(t)).update=function(e){f.html("Account balance: <strong>".i18n()+formatPrice(e,n)+"</strong>")},(d=(0,c.default)("<table width='100%' class='portfolio-dialog hover'/>")).appendTo(u),(d=d.dataTable({data:[],columns:[{title:"Ref.".i18n()},{title:"Contract Details".i18n()},{title:"Purchase".i18n(),render:function(e){return'<span class="bold">'+formatPrice(e,n)+"</span>"}},{title:"Indicative".i18n(),render:function(e){return'<span class="bold">'+formatPrice(e,n)+"</span>"}},{title:""}],rowId:"5",paging:!1,ordering:!1,processing:!0})).parent().addClass("hide-search-input"),u.on("click",C),u.track({module_id:"portfolio",is_unique:!0,data:null}),u.dialog("open")}).catch(function(e){})},P=function(e){e.forEach(function(e){p.push(e),s.default.proposal_open_contract.subscribe(e.contract_id).catch(function(e){})})},k=function(e){var t=e.map(function(e){return s.default.proposal_open_contract.forget(e.contract_id).catch(function(e){return c.default.growl.error({message:e.message})})}),n=_.map(e,"contract_id");return p=p.filter(function(e){return!1===_.includes(n,e.contract_id)}),Promise.all(t)},T=(m=i.default.mark(function e(){var t,n,a,r,o;return i.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return t=(0,c.default)("#"+d.attr("id")+"_processing").show(),e.prev=1,e.next=4,s.default.send({portfolio:1});case 4:n=e.sent,a=n.portfolio&&n.portfolio.contracts,r="<button>View</button>".i18n(),o=a.map(function(e){return[e.transaction_id,e.longcode,e.buy_price,"0.00",r,e.contract_id,e]}),a.forEach(function(e){return s.default.sell_expired(e.expiry_time)}),P(a),d.api().rows().remove(),d.api().rows.add(o),d.api().draw(),t.hide(),e.next=23;break;case 16:e.prev=16,e.t0=e.catch(1),d.api().rows().remove(),d.api().draw(),t.hide(),c.default.growl.error({message:e.t0.message});case 23:case"end":return e.stop()}},e,void 0,[[1,16]])}),w=function(){var c=m.apply(this,arguments);return new Promise(function(o,i){return function t(e,n){try{var a=c[e](n),r=a.value}catch(e){return void i(e)}if(!a.done)return Promise.resolve(r).then(function(e){t("next",e)},function(e){t("throw",e)});o(r)}("next")})},function(){return w.apply(this,arguments)}),q=e.proposal_open_contract={subscribe:function(){return y("subscribe")},forget:function(){return y("forget")},resubscribe:function(){return y("resubscribe")}};e.default={init:v,proposal_open_contract:q}});