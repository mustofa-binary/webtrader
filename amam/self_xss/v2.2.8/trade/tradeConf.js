define(["exports","jquery","moment","./lookback","../charts/chartingRequestMap","../charts/chartSettings","../websockets/binary_websockets","../common/rivetsExtra","text!../trade/tradeConf.html","../common/util","css!../trade/tradeConf.css"],function(t,e,i,r,a,o,n,c,s){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.init=void 0;var l=f(e),h=f(i),u=f(r),d=f(a),b=f(n),_=f(c),p=f(s);function f(t){return t&&t.__esModule?t:{default:t}}var y=["entry_spot_tick","barrier","exit_spot_tick"];_.default.binders["tick-chart"]={priority:65,bind:function(t){var e=this.model;t.chart=new Highcharts.Chart({subtitle:{text:(0,o.getLabelEl)(y),useHTML:!0},title:"",credits:{enabled:!1},chart:{type:"line",renderTo:t,backgroundColor:null,width:400,height:144,marginLeft:20,marginTop:35,marginBottom:15},tooltip:{useHTML:!0,formatter:function(){var t=e.array[this.x-1];if(t&&t.tooltip)return"<div class='tooltip-body'>"+t.tooltip+"</div>"}},xAxis:{type:"linear",min:1,max:1*t.getAttribute("tick-count")+1,labels:{enabled:!1}},yAxis:{labels:{align:"left",x:0,formatter:function(){return addComma(this.value,e.display_decimals)}},title:"",gridLineWidth:0},series:[{data:[]},{type:"scatter",marker:{enabled:!1},data:[]}],plotOptions:{scatter:{enableMouseTracking:!1}},exporting:{enabled:!1,enableImages:!1},legend:{enabled:!1}})},routine:function(t,e){var i,r,a,o,n,c,s,l,u=this.model,d=e.length,_=u.makeBarrier(),p=u.contract_is_finished;if(_&&(i=_,t.chart.yAxis[0].removePlotLine(i.id),r=t.chart,a=i,r.yAxis[0].addPlotLine({id:a.id,value:a.value,color:"green",width:2}),r.series[1].addPoint([1,1*a.value])),p)return o=u,n=e.findIndex(function(t){return t.epoch===+o.exit_tick_time}),void f(t.chart,{value:n+1,dashStyle:"Dash"});0!==d&&(s=e[(c=d)-1],t.chart.series[0].addPoint([c,s.quote]),1===d&&(l=d,f(t.chart,{value:l})));function f(t,e){t.xAxis[0].addPlotLine({value:e.value,id:e.id||e.value,color:e.color||"#e98024",width:e.width||2,dashStyle:e.dashStyle||!1})}}};var m=function(u,d){var _=void 0,i=void 0,r=void 0,p=!1,f=d.tick_count,a=function(e){var t,i,r,a,o,n,c,s=+e.epoch>=+_.entry_tick_time;if(!u.ticks.array.some(function(t){return t.epoch===+e.epoch})&&!u.ticks.contract_is_finished&&s){var l="open"!==_.status&&(f<-1||p);u.buy.barrier=_.barrier?+_.barrier:null,l&&(y(_),c=u.ticks.array.slice(),u.ticks.array=[].concat(function(t){if(Array.isArray(t)){for(var e=0,i=Array(t.length);e<t.length;e++)i[e]=t[e];return i}return Array.from(t)}(c))),-1<--f&&(p=e.epoch>=_.exit_tick_time,r=t=e,a=h.default.utc(1e3*r.epoch).format("dddd, MMM D, HH:mm:ss"),o=d.symbol_name,n=addComma(+r.quote,u.ticks.display_decimals),i=a+"<br/>"+o+" "+n,u.ticks.array.push({quote:+t.quote,epoch:+t.epoch,number:u.ticks.array.length+1,tooltip:i}))}};var y=function(t){var e;e=d.contract_id,b.default.events.off("proposal_open_contract",i),b.default.events.off("tick",r),b.default.proposal_open_contract.forget(e),u.ticks.contract_is_finished=!0,u.ticks.exit_tick_time=t.exit_tick_time?t.exit_tick_time:null,u.ticks.status=t.status,u.buy.update(),u.back.visible=!0};i=b.default.events.on("proposal_open_contract",function(t){t.proposal_open_contract.contract_id!==d.contract_id||(t.error?e(t):_=t.proposal_open_contract)});var o=[],n=void 0,c=!1;r=b.default.events.on("tick",function(t){if(!(d.symbol!==t.tick.symbol)){n||(n=t.tick.epoch);var e,i,r=_&&_.entry_tick_time;if(r)+r<+n&&(c=!0,e=n=r,i=d.symbol,b.default.send({ticks_history:i,end:"latest",start:e,style:"ticks",count:5e3}).then(function(i){c=!1,i.history.prices.forEach(function(t,e){o.push({epoch:i.history.times[e],quote:t,symbol:d.symbol})}),o.sort(function(t,e){return+t.epoch-+e.epoch})}).catch(function(t){return l.default.growl.error({message:data.error.message})})),c?o.push(t.tick):(0<o.length&&(o.forEach(function(t){return a(t)}),o=[]),a(t.tick));else o.push(t.tick)}});var e=function(t){l.default.growl.error({message:t.error.message}),b.default.proposal_open_contract.forget(t.echo_req.contract_id),b.default.proposal_open_contract.subscribe(t.echo_req.contract_id)}},v=t.init=function(t,i,e,r){var a=d.default.digits_after_decimal(i.pip,i.symbol),o=(0,l.default)(p.default).i18n(),n=t.buy,c={title:{text:"Contract Confirmation".i18n()},buy:{barrier:null,message:n.longcode,balance_after:n.balance_after,buy_price:(+n.buy_price).toFixed(currencyFractionalDigits()),purchase_time:n.purchase_time,start_time:n.start_time,transaction_id:n.transaction_id,payout:(+n.payout).toFixed(currencyFractionalDigits()),currency:i.currency,potential_profit:(n.payout-n.buy_price).toFixed(currencyFractionalDigits()),potential_profit_text:"Profit".i18n(),show_result:!1},spreads:{amount_per_point:n.amount_per_point||"0",stop_loss_level:n.stop_loss_level||"0",stop_profit_level:n.stop_profit_level||"0"},ticks:{array:[],contract_is_finished:!1,display_decimals:a,exit_tick_time:null,is_path_dependent:null,makeBarrier:function(){var t=c.buy.barrier;return t?{value:+t}:null},tick_count:i.tick_count,value:(i.digits_value||"0")+"",category:i.category,category_display:i.category_display,status:"waiting",chart_visible:i.show_tick_chart},arrow:{visible:!i.show_tick_chart&&"digits"!==i.category.contract_category},back:{visible:!1}};u.default.isLookback(i.category_display.contract_type)&&(c.buy.payout=u.default.formula(i.category_display.contract_type,i.amount),c.buy.potential_profit=void 0),c.buy.update=function(){var t=c.ticks.status;c.title.text={waiting:"Contract Confirmation".i18n(),won:"This contract won".i18n(),lost:"This contract lost".i18n()}[t],"lost"===t&&(c.buy.potential_profit=(-c.buy.buy_price).toFixed(currencyFractionalDigits()),c.buy.payout=(0).toFixed(currencyFractionalDigits()),c.buy.potential_profit_text="Lost"),"won"===t&&(c.buy.balance_after=1*n.balance_after+1*c.buy.payout,b.default.sell_expired()),c.buy.show_result=!0},c.back.onclick=function(){return r(o)},c.arrow.onclick=function(t){var e=(0,l.default)(t.target);e.hasClass("disabled")||(e.addClass("disabled"),require(["viewtransaction/viewTransaction"],function(t){t.init(i.contract_id,i.transaction_id).then(function(){return e.removeClass("disabled")})}))};_.default.bind(o[0],c);c.arrow.visible?c.back.visible=!0:m(c,i),e(o)};t.default={init:v}});