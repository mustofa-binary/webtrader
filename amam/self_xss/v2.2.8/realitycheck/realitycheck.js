define(["exports","jquery","../windows/windows","../websockets/binary_websockets","../common/rivetsExtra","lodash","moment","jquery-growl","../common/util"],function(e,t,n,i,l,a,o){"use strict";Object.defineProperty(e,"__esModule",{value:!0});var u=m(t),c=m(n),r=m(i),s=m(l),d=(m(a),m(o));function m(e){return e&&e.__esModule?e:{default:e}}var h=null,f=null,_=[],g={timeOutInMins:(local_storage.get("realitycheck")||{}).timeOutInMins||10,timeOutMin:10,timeOutMax:60,loginId:null,durationInMins:null,bought:null,turnOver:null,loginTime:null,sold:null,pnl:null,currentTime:null,open:null,potentialProfit:null,currency:null,continueTrading:function(e,t){t.timeOutInMins<t.timeOutMin||t.timeOutInMins>t.timeOutMax?u.default.growl.error({message:"Please enter a number between ".i18n()+t.timeOutMin+" and ".i18n()+t.timeOutMax}):(h.dialog("close"),local_storage.set("realitycheck",{timeOutInMins:0|t.timeOutInMins,accepted_time:d.default.utc().valueOf()}),v(t.timeOutInMins))},openStatement:function(){require(["statement/statement"],function(e){var t=(0,u.default)("#nav-menu").find("a.statement");e.init(t),t.click()})},logout:function(){return r.default.invalidate()}},y=function(e){if(h){var t=h.dialog("widget");e?(h.dialog({height:260}),t.find(".realitycheck_firstscreen").show(),t.find(".realitycheck_secondscreen").hide()):(h.dialog({height:310}),t.find(".realitycheck_firstscreen").hide(),t.find(".realitycheck_secondscreen").show())}},v=function(e){f&&clearTimeout(f),f=setTimeout(function(){r.default.send({reality_check:1}).then(function(e){if(!local_storage.get("authorize").is_virtual){var t=d.default.utc().valueOf()-1e3*e.reality_check.start_time,n=1728e5;n<t&&(t=n);var i=currencyFractionalDigits();g.durationInMins=d.default.duration(t).humanize(),g.bought=e.reality_check.buy_count,g.turnOver=e.reality_check.buy_amount,g.loginTime=d.default.utc(1e3*e.reality_check.start_time).format("MMM D, YYYY hh:mm")+" GMT",g.sold=e.reality_check.sell_count,g.pnl=(e.reality_check.sell_amount-e.reality_check.buy_amount).toFixed(i),g.currentTime=d.default.utc().format("MMM D, YYYY hh:mm")+" GMT",g.open=e.reality_check.open_contract_count,g.potentialProfit=e.reality_check.potential_profit,g.currency=e.reality_check.currency,y(!1),h.moveToTop()}})},60*e*1e3)},k=function(){return h?Promise.resolve(!0):new Promise(function(n){r.default.cached.authorize().then(function(e){g.loginId=e.authorize.loginid,r.default.cached.send({landing_company_details:e.authorize.landing_company_name}).then(function(e){e&&e.landing_company_details.has_reality_check?require(["text!realitycheck/realitycheck.html","css!realitycheck/realitycheck.css"],function(e){var t=(0,u.default)(e).i18n();h=c.default.createBlankWindow((0,u.default)("<div/>"),{title:"Reality check".i18n(),width:600,minHeight:260,height:260,resizable:!1,collapsable:!1,minimizable:!1,maximizable:!1,closable:!1,modal:!0,closeOnEscape:!1,ignoreTileAction:!0,"data-authorized":"true"}),t.appendTo(h),(0,u.default)("body").append(h.dialog("widget")),y(!0),s.default.bind(t[0],g),n()}):local_storage.remove("realitycheck")})}).catch(function(e){return local_storage.remove("realitycheck")})})},M=function(){h&&h.dialog("close"),f&&clearTimeout(f),f=null,g.timeOutInMins=10,g.loginId=null,g.durationInMins=null,g.bought=null,g.turnOver=null,g.loginTime=null,g.sold=null,g.pnl=null,g.currentTime=null,g.open=null,g.potentialProfit=null,g.currency=null},p=function(){if(M(),!local_storage.get("authorize").is_virtual){var e=k();_.push(e),Promise.all(_).then(function(){y(!0),setTimeout(function(e){return h.dialog("open")},1e3),_=[]})}};r.default.events.on("oauth-login",p),r.default.events.on("login",function(e){g.loginId!=e.authorize.loginid&&M();var t=local_storage.get("realitycheck");if(t&&!local_storage.get("authorize").is_virtual){var n=(d.default.utc().valueOf()-t.accepted_time)/60/1e3;setTimeout(function(e){return k().then(function(){var e=n>=t.timeOutInMins?0:Math.abs(t.timeOutInMins-n);v(e)})},1e3)}else p()}),r.default.events.on("reset_realitycheck",function(){M(),local_storage.remove("realitycheck")}),r.default.events.on("switch_account",function(){local_storage.remove("realitycheck"),p()}),e.default={}});