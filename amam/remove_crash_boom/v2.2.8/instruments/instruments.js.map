{"version":3,"sources":["../../../../src/instruments/instruments.es6"],"names":["refresh_active_symbols","liveapi","cached","send","active_symbols","then","data","local_storage","set","active_markets","_","groupBy","map","symbols","filtered_symbols","filter","isRestrictedSymbol","item","symbol","sym","head","market","name","display_name","market_display_name","submarkets","submarket","submarket_display_name","instruments","push","value","markets","chartable_markets","m","sm","ins","indexOf","length","find","remove","menu","refreshMenu","onMenuItemClick","displayName","chartWindow","addNewWindow","instrumentCode","instrumentName","timePeriod","type","init","trading_times","Date","toISOString","slice","extractChartableMarkets","events","on","getMarketData","isMarketDataPresent","marketDataDisplayName","marketData","present","instrumentObj","$","each","key","trim","getSpecificMarketData","isEmptyObject"],"mappings":"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","file":"instruments.js","sourcesContent":["import $ from \"jquery\";\nimport liveapi from \"websockets/binary_websockets\";\nimport menu from \"navigation/menu\";\nimport chartWindow from \"charts/chartWindow\";\nimport { getSortedMarketSubmarkets } from '../common/marketUtils';\nimport \"jquery-growl\";\nimport \"common/util\";\n\nfunction refresh_active_symbols() {\n    liveapi\n        .cached\n        .send({ active_symbols: 'brief' })\n        .then(function(data) {\n            local_storage.set('active_symbols', data.active_symbols);\n            const active_symbols = [];\n            const active_markets = _(data.active_symbols).groupBy('market').map(function(symbols) {\n             \n                const filtered_symbols = symbols.filter(item => !isRestrictedSymbol(item.symbol))\n  \n                const sym = _.head(filtered_symbols);\n     \n                const market = { name: sym.market, display_name: sym.market_display_name };\n                market.submarkets = _(filtered_symbols).groupBy('submarket').map(function(symbols) {\n                    const sym = _.head(symbols);\n                    const submarket = { name: sym.submarket, display_name: sym.submarket_display_name };\n                    submarket.instruments = _.map(symbols, function(sym) {\n                        active_symbols.push(sym.symbol);\n                        return {\n                            symbol: sym.symbol,\n                            display_name: sym.display_name,\n                        };\n                    });\n                    return submarket;\n                }).value();\n                return market;\n            }).value();\n            markets = chartable_markets.map(function(m) {\n                return {\n                    display_name: m.display_name,\n                    name: m.name,\n                    submarkets: m.submarkets.map(function(sm) {\n                        return {\n                            display_name: sm.display_name,\n                            instruments: sm.instruments.filter(function(ins) {\n                                return active_symbols.indexOf(ins.symbol) !== -1;\n                            })\n                        }\n                    }).filter(function(sm) {\n                        return sm.instruments.length !== 0;\n                    })\n                }\n            }).filter(function(m) {\n                return m.submarkets.length !== 0;\n            });\n\n            markets = getSortedMarketSubmarkets(markets);\n\n            const instruments = $(\"#nav-menu\").find(\".instruments\");\n            instruments.find('> ul').remove();\n            menu.refreshMenu(instruments , markets, onMenuItemClick);\n        });\n}\n\nfunction onMenuItemClick(symbol, displayName) {\n    chartWindow.addNewWindow({\n        instrumentCode: symbol,\n        instrumentName: displayName,\n        timePeriod: '1d',\n        type: 'candlestick'\n    });\n}\n\nlet markets = [];\nlet chartable_markets = [];\n\nexport const init = function() {\n    return liveapi\n        .cached.send({ trading_times: new Date().toISOString().slice(0, 10) })\n        .then(function(data) {\n            chartable_markets = menu.extractChartableMarkets(data);\n            refresh_active_symbols();\n            liveapi.events.on('login', refresh_active_symbols);\n            liveapi.events.on('logout', refresh_active_symbols);\n\n            return chartable_markets;\n        });\n}\n\nexport const getMarketData = function() {\n    return markets;\n}\n\nexport const isMarketDataPresent = function(marketDataDisplayName, marketData) {\n    let present = false;\n    if (!marketData) {\n        marketData = markets;\n    }\n\n    const instrumentObj = this;\n    $.each(marketData, function(key, value) {\n        if (value.submarkets || value.instruments) {\n            present = instrumentObj.isMarketDataPresent(marketDataDisplayName, value.submarkets || value.instruments);\n        } else {\n            if ($.trim(value.display_name) == $.trim(marketDataDisplayName)) {\n                present = true;\n            }\n        }\n        return !present;\n    });\n    return present;\n}\n\nexport const getSpecificMarketData = function(marketDataDisplayName, marketData) {\n    let present = {};\n    if (!marketData) {\n        marketData = markets;\n    }\n\n    const instrumentObj = this;\n    $.each(marketData, function(key, value) {\n        if (value.submarkets || value.instruments) {\n            present = instrumentObj.getSpecificMarketData(marketDataDisplayName, value.submarkets || value.instruments);\n        } else {\n            if ($.trim(value.display_name) == $.trim(marketDataDisplayName)) {\n                present = value;\n            }\n        }\n        return $.isEmptyObject(present);\n    });\n    return present;\n}\n\nexport default {\n    init,\n    getMarketData,\n    isMarketDataPresent,\n    getSpecificMarketData\n}\n"]}