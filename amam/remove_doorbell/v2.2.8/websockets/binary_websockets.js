define(["exports","jquery","text!../oauth/app_id.json","common/util"],function(e,t,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.sell_expired=e.is_authenticated=e.send=e.cached=e.switch_account=e.execute=e.proposal_open_contract=e.events=e.invalidate=e.server_url=e.app_id=e.socket_url=void 0;var r=o(t),i=o(n);function o(e){return e&&e.__esModule?e:{default:e}}var s=!1,a=null,c=!1,u={},l=function(){return localStorage.getItem("config.server_url")||"frontend.binaryws.com"},f=e.socket_url="wss://"+l()+"/websockets/v3",d=e.app_id=localStorage.getItem("config.app_id")||function(){var e=JSON.parse(i.default),t=window.location.href,n="";for(var r in e)if(0===t.lastIndexOf(r,0)){n=e[r];break}var o=n||11;return localStorage.setItem("config.app_id",o),o}(),_=e.server_url=l(),g=function(){var e=(local_storage.get("i18n")||{value:"en"}).value,t=new WebSocket(f+"?l="+e+"&app_id="+d);return t.addEventListener("open",S),t.addEventListener("close",h),t.addEventListener("message",q),t.addEventListener("error",function(e){r.default.growl.error({message:"Connection error.".i18n()}),h()}),t},v=!1,h=function(){require(["windows/tracker"],function(e){var t=e.get_trade_dialogs(),n=e.get_unique_dialogs();s=!1,N("logout"),v||(v=!0,setTimeout(function(){v=!1,a=g(),local_storage.get("oauth")&&I.cached.authorize().then(function(){e.reopen_trade_dialogs(t),setTimeout(function(){return e.reopen_unique_dialogs(n)},0)})},1e3))})},p={},m=[],b=[],w={},y={},x=function(){return a&&1===a.readyState},S=function(){for(a.send(JSON.stringify({website_status:1,subscribe:1}));0<b.length;){var e=b.shift();w[e.req_id]||a.send(JSON.stringify(e))}for(var t in w){var n=w[t];n&&(n.sent_before?n.reject({message:"Connection closed.".i18n()}):(n.sent_before=!0,a.send(JSON.stringify(n.data))))}for(;0<m.length;)m.shift()()},q=function(e){var n=JSON.parse(e.data);p[n.msg_type]=p[n.msg_type]||[];for(var t=function(e){var t=p[n.msg_type][e];setTimeout(function(){return t(n)},0)},r=0;r<p[n.msg_type].length;r++)t(r);var o=n.req_id,i=w[o]||u[o];i&&(delete w[o],delete u[o],n.error?(n.error.echo_req=n.echo_req,n.error.req_id=n.req_id,i.reject(n.error)):i.resolve(n))};a=g();var O=function(e){for(var t in{balance:1,statement:1,profit_table:1,portfolio:1,proposal_open_contract:1,buy:1,sell:1,get_self_exclusion:1,set_self_exclusion:1})if(t in e)return!0;return!1},j=0,k=function(n){return n.req_id=++j,new Promise(function(e,t){c?(w[n.req_id]={resolve:e,reject:t,data:n},x()?a.send(JSON.stringify(n)):b.push(n)):u[n.req_id]={resolve:e,reject:t,data:n}})},z=function(e){var r=!1,o={authorize:e},i=JSON.stringify(o),a=k(o);return a.then(function(e){s=!0,local_storage.set("authorize",e.authorize);var t=-1!==e.authorize.landing_company_name.indexOf("japan");if(t||N("login",e),local_storage.get("oauth-login")){var n=local_storage.get("oauth-login").value;local_storage.remove("oauth-login"),n&&!t&&N("oauth-login",e)}return r=!0,y[i]={data:o,promise:a},e}).catch(function(e){throw"SelfExclusion"===e.code||r||(s=!1,N("logout"),local_storage.remove("oauth")),delete y[i],e})},J=e.invalidate=function(){for(var e in local_storage.remove("oauth"),local_storage.remove("authorize"),N("reset_realitycheck"),N("reset_accountstatus"),I.send({logout:1}).catch(function(e){r.default.growl.error({message:e.message}),a.close()}),y)(O(y[e].data)||"authorize"in y[e].data)&&delete y[e];s=!1},N=function(e){for(var t=arguments.length,n=Array(1<t?t-1:0),r=1;r<t;r++)n[r-1]=arguments[r];(p[e]||[]).forEach(function(e){setTimeout(function(){return e.apply(void 0,n)},0)})},P={},T={},E={},I={events:e.events={on:function(e,t){return(p[e]=p[e]||[]).push(t),t},off:function(e,t){if(p[e]){var n=p[e].indexOf(t);-1!==n&&p[e].splice(n,1)}},on_till:function(t,n){I.events.on(t,function e(){n.apply(void 0,arguments)&&I.events.off(t,e)})}},proposal_open_contract:e.proposal_open_contract={subscribe:function(t){if(T[t]&&0<T[t].subscribers)return T[t].subscribers++,T[t].promise;var e=I.send({proposal_open_contract:1,contract_id:t,subscribe:1}).then(function(e){return T[t].stream_id=e.proposal_open_contract.id,e}).catch(function(e){throw T[t]=void 0,e});return T[t]={subscribers:1,promise:e},e},forget:function(t){var n=T[t],e=E[t];if(!n)return e||Promise.resolve();if(0==n.subscribers)return e;if(n.subscribers--,0<n.subscribers)return Promise.resolve();var r=function(){return T[t]=void 0,I.send({forget:n.stream_id}).catch(function(e){throw E[t]=void 0,e}).then(function(e){return E[t]=void 0,e})};return n.stream_id?E[t]=r():E[t]=n.promise.catch(function(e){}).then(function(e){return n.stream_id?r():void 0}),E[t]}},execute:e.execute=function(e){x()?setTimeout(e,0):m.push(e)},switch_account:e.switch_account=function(e){var t=local_storage.get("oauth");if(!t)return Promise.reject({message:"Account token not found.".i18n()});var n=t.map(function(e){return e.id}).indexOf(e);if(-1===n)return promise.reject({message:"Account id not found.".i18n()});var r=t[n];for(var o in t.splice(n,1),t.unshift(r),local_storage.set("oauth",t),y)(O(y[o].data)||"authorize"in y[o].data)&&delete y[o];return s=!1,I.send({forget_all:"transaction"}).catch(function(e){}),I.send({forget_all:"balance"}).catch(function(e){}),I.cached.authorize().then(function(e){return N("switch_account",e)})},cached:e.cached={send:function(e){var t=JSON.stringify(e);return y[t]?y[t].promise:(y[t]={data:e,promise:null},y[t].promise=I.send(e).then(function(e){return e},function(e){throw delete y[t],e}))},authorize:function(e){var t=local_storage.get("oauth"),n=t&&t[0]&&t[0].token,r=JSON.stringify({authorize:n});return s&&n&&y[r]&&!e?y[r].promise:n?z(n):Promise.reject("Please log in.".i18n())}},send:e.send=function(e,t){if(e&&O(e))return function(e){if(s)return k(e);var t=k.bind(null,e);if(local_storage.get("oauth")){var n=local_storage.get("oauth")[0].token;return z(n).then(t)}return Promise.reject({message:"Please log in".i18n()})}(e);var n,r=k(e);return t&&(n=e.req_id,setTimeout(function(){var e=w[n];e&&(delete w[n],e.reject({message:"Timeout for websocket request".i18n()}))},t)),r},is_authenticated:e.is_authenticated=function(){return s},sell_expired:e.sell_expired=function(e){var t=(new Date).getTime()/1e3|0;!P[e=e||t+1]&&t<1*e&&(P[e]=setTimeout(function(){P[e]=void 0,I.send({sell_expired:1}).catch(function(e){})},1e3*(e+2-t)))},invalidate:J,app_id:d,socket_url:f,server_url:_};I.events.on("website_status",function(e){if(c=e.website_status&&"up"===e.website_status.site_status.toLowerCase())for(var t in u)u[t].is_sent||(a.send(JSON.stringify(u[t].data)),u[t].is_sent=1)}),I.events.on("login",function(){I.send({transaction:1,subscribe:1}).catch(function(e){}),I.send({balance:1,subscribe:1}).catch(function(e){})}),I.events.on("logout",function(){I.send({forget_all:"transaction"}).catch(function(e){}),I.send({forget_all:"balance"}).catch(function(e){})}),setInterval(function(){return I.send({ping:1})},3e4),e.default=I});